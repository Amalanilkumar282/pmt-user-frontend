<!-- board-column.component.html -->
<div class="board-column rounded-2xl shadow-sm p-4" [style.border-left]="'3px solid ' + def.color" [style.background-color]="'#F8FAFC'">
  <!-- Header -->
  <div class="mb-4 flex items-center justify-between">
    <div class="flex items-center gap-2">
      <h3 class="text-xs font-bold uppercase tracking-wide" style="color: #3D62A8">{{ def.title }}</h3>
      <span class="text-xs font-bold rounded-full min-w-[24px] h-6 px-2 flex items-center justify-center" [style.color]="'#3D62A8'" [style.background-color]="'#f4f5f7'">{{ items.length }}</span>
    </div>
    <div class="flex gap-3">
      <button aria-label="Delete column" title="Delete column" (click)="onDeleteColumn()" class="text-slate-400 hover:text-rose-500 hover:cursor-pointer focus:outline-none transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Drop List Container -->
  <div
    cdkDropList
    [id]="def.id"
    [cdkDropListData]="sortedItems"
    [cdkDropListConnectedTo]="connectedTo"
    (cdkDropListDropped)="drop($event)"
    class="min-h-16 space-y-3 max-h-[60vh] overflow-y-auto board-column-scroll">

    <!-- Single loop with group headers - all cdkDrag items are direct children -->
    <ng-container *ngFor="let issue of sortedItems; let i = index; trackBy: trackById">
      <!-- Group header (shown when group changes) -->
      <div 
        *ngIf="shouldShowGroupHeader(issue, getPreviousIssue(i))" 
        class="flex items-center gap-2 py-2 px-1"
        [class.mt-4]="i > 0"
        [class.mt-0]="i === 0">
        <div class="flex-1 h-px bg-slate-200"></div>
        <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider px-2">
          {{ getGroupKey(issue) }}
        </span>
        <div class="flex-1 h-px bg-slate-200"></div>
      </div>
      
      <!-- Draggable task card - direct child of cdkDropList -->
      <app-task-card
        cdkDrag
        [issue]="issue"
        [colorClass]="def.color"
        (open)="onOpen($event)"
        (openComments)="onOpenComments($event)"
        class="cursor-move">
      </app-task-card>
    </ng-container>
    
    <!-- Quick Create Issue -->
    <app-quick-create-issue 
      [status]="def.id"
      (issueCreated)="onQuickCreate($event)">
    </app-quick-create-issue>
    
    <!-- spacer to ensure last task is fully scrollable into view -->
    <div class="column-end-spacer" aria-hidden="true"></div>
  </div>

  <!-- Load More Button -->
  <button 
    *ngIf="items.length > pageItems.length"
    (click)="loadMore()"
    class="mt-3 w-full rounded-lg border border-slate-200 bg-white py-2 text-sm hover:bg-slate-50 cursor-pointer">
    Load more
  </button>
</div>
