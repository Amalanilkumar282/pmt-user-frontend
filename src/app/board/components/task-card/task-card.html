<div class="task-card bg-white rounded-xl p-2 mb-3 cursor-pointer hover:shadow-md transition-all duration-300 group/card relative" 
     [style.border-left]="'3px solid ' + colorClass"
     [class.z-50]="showAssigneeDropdown() || showDatePicker()"
     [class.z-10]="true"
  (click)="onOpenCard($event)">
  <div class="content" cdkDragHandle>
    <div class="content-header flex items-start justify-between">
      <!-- Title - Click icon to edit -->
      <div class="flex-1 mr-2 group">
        @if (!isEditingTitle()) {
          <div class="flex items-center gap-1.5">
            <h4 class="flex-1 text-[14px] font-bold text-slate-600 mb-3 leading-snug px-1 -mx-1 rounded transition-colors">
              {{ issue.title }}
            </h4>
            <svg class="w-3.5 h-3.5 text-slate-400 opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0 mb-3 cursor-pointer hover:text-blue-500" 
                 (click)="startEditingTitle($event)"
                 title="Edit title"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
            </svg>
          </div>
        } @else {
          <div appClickOutside (outsideClick)="saveTitle()">
            <textarea
              [(ngModel)]="editedTitle"
              (keydown)="onTitleKeydown($event)"
              (click)="$event.stopPropagation()"
              (input)="autoResizeTitleTextarea($event)"
              #titleTextarea
              rows="1"
              class="w-full text-[14px] font-bold text-slate-600 mb-3 leading-snug px-1 -mx-1 border-2 border-blue-500 rounded focus:outline-none focus:ring-2 focus:ring-blue-400 resize-none overflow-hidden"
              autofocus></textarea>
          </div>
        }
      </div>
    
       <!-- Priority Badge (top right) -->
    <div class=" top-3 right-3 text-[10px] px-2.5 rounded-full py-1 rounded font-bold uppercase" [ngClass]="getPriorityPill(issue.priority)">
      {{ issue.priority }}
    </div>
    </div>
    
    <!-- ID and Epic on same line -->
    <div class="flex items-center justify-between gap-2 mb-3">
      <!-- Key (or ID) - More prominent styling -->
      <div class="inline-flex items-center gap-1.5 px-2 py-1 bg-slate-100 rounded-md">
        <span class="text-xs font-bold text-slate-700 uppercase tracking-wide">{{ issue.key || issue.id }}</span>
      </div>

      <!-- Epic Badge (if assigned to epic) - compact pill with truncation and tooltip -->
      <div *ngIf="issue.epicId">
        <div class="epic-pill" [title]="getEpicName(issue.epicId)">
          <svg class="epic-icon" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
          <span class="epic-label">{{ getEpicName(issue.epicId) }}</span>
        </div>
      </div>
    </div>

    <!-- Labels/Tags - compact, limited, consistent padding -->
    <div class="flex items-center gap-2 mb-3" *ngIf="issue.labels && issue.labels.length > 0">
      <ng-container *ngFor="let tag of issue.labels; let i = index">
        <span *ngIf="i < 2" class="tag-pill"
              [style.background-color]="getLabelBgColor(tag)"
              [style.color]="getLabelTextColor(tag)">
          {{ tag }}
        </span>
      </ng-container>

      <!-- Overflow counter for additional tags -->
      <span *ngIf="issue.labels.length > 2" class="tag-more" [title]="issue.labels.slice(2).join(', ')">+{{ issue.labels.length - 2 }}</span>
    </div>

    <!-- Description -->
    <div class="mb-4 group/desc" *ngIf="issue.description || isEditingDescription()">
      <div class="relative">
        @if (!isEditingDescription()) {
          <div class="flex items-start gap-2">
            <div class="flex-1 min-w-0">
              <p class="text-[13px] text-slate-600 line-clamp-2 leading-relaxed hover:bg-slate-50 transition-colors cursor-pointer px-2 py-1 rounded" 
                 (click)="startEditingDescription($event)">
                {{ issue.description }}
              </p>
            </div>
            <svg class="w-3.5 h-3.5 text-slate-400 opacity-0 group-hover/desc:opacity-100 transition-opacity flex-shrink-0 cursor-pointer hover:text-blue-500 mt-1" 
                 (click)="startEditingDescription($event)"
                 title="Edit description"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
            </svg>
          </div>
        } @else {
          <div appClickOutside (outsideClick)="saveDescription()">
            <textarea 
              [(ngModel)]="editedDescription"
              (click)="$event.stopPropagation()"
              (keydown.escape)="cancelEditingDescription()"
              (keydown.meta.enter)="saveDescription()"
              (keydown.ctrl.enter)="saveDescription()"
              class="w-full text-[13px] text-slate-600 leading-relaxed px-2 py-1 border-2 border-blue-500 rounded focus:outline-none focus:ring-2 focus:ring-blue-400 resize-y min-h-[60px]"
              placeholder="Add a description..."
              autofocus
              rows="3"></textarea>
            <div class="flex items-center justify-end gap-2 mt-1">
              <button (click)="cancelEditingDescription()" class="text-xs px-2 py-1 text-slate-600 hover:bg-slate-100 rounded">Cancel</button>
              <button (click)="saveDescription()" class="text-xs px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">Save</button>
            </div>
          </div>
        }
      </div>
    </div>

    <!-- Progress Bar -->
    <div class="mb-4">
      <div class="h-1.5 bg-slate-100 rounded-full overflow-hidden relative">
        <div class="h-full rounded-full transition-all duration-300" 
             [style.background-color]="progressColor()" 
             [style.width.%]="getProgressValue()"
             [attr.title]="getProgressTooltip()"></div>
        <!-- Subtle overdue stripe overlay -->
        <div *ngIf="isOverdue()" class="absolute inset-0 bg-gradient-to-r from-transparent via-red-100/30 to-transparent opacity-60"></div>
      </div>
      <!-- Overdue indicator badge - more subtle -->
      <div *ngIf="isOverdue()" class="flex items-center gap-1 mt-1.5 px-2 py-0.5 bg-red-50 rounded-md w-fit">
        <svg class="w-3 h-3 text-red-500" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
        </svg>
        <span class="text-[10px] text-red-600 font-medium">Overdue</span>
      </div>
    </div>    <!-- Footer -->
    <div class="flex items-center justify-between text-xs text-slate-500">
      <div class="flex items-center gap-2">
        <div class="relative">
          <div class="w-7 h-7 rounded-full flex items-center justify-center font-bold text-white text-[11px] cursor-pointer hover:ring-2 hover:ring-blue-400 transition-all"
               [style.background-color]="displayAssignee() | avatarClass"
               [title]="displayAssignee() + ' (Click to change)'"
               (click)="onAssigneeClick($event)">
            {{ displayAssignee() | initials }}
          </div>
          
          <!-- Assignee Dropdown -->
          @if (showAssigneeDropdown()) {
            <div class="absolute z-[100] mt-1 bg-white rounded-lg shadow-xl border border-slate-200 py-2 min-w-[200px] left-0"
                 appClickOutside 
                 (outsideClick)="closeAssigneeDropdown()"
                 (click)="$event.stopPropagation()">
              <!-- Search Bar -->
              <div class="px-3 pb-2">
                <input
                  type="text"
                  [(ngModel)]="assigneeSearchQuery"
                  placeholder="Search assignees..."
                  class="w-full px-2 py-1.5 text-xs border border-slate-300 rounded focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                  (click)="$event.stopPropagation()"
                  autofocus />
              </div>
              
              <!-- Scrollable List -->
              <div class="max-h-[200px] overflow-y-auto">
                @for (a of filteredAssignees(); track a) {
                  <button
                    type="button"
                    (click)="selectAssignee(a)"
                    class="w-full px-3 py-2 text-left text-xs hover:bg-slate-50 flex items-center gap-2 transition-colors cursor-pointer"
                    [class.bg-blue-50]="a.name === displayAssignee()">
                    <div class="w-6 h-6 rounded-full flex items-center justify-center text-white text-[10px] font-bold"
                         [style.background-color]="a.name | avatarClass">
                      {{ a.name | initials }}
                    </div>
                    <span class="font-medium text-slate-700">{{ a.name }}</span>
                    @if (a.name === displayAssignee()) {
                      <svg class="w-3 h-3 ml-auto text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                      </svg>
                    }
                  </button>
                } @empty {
                  <div class="px-3 py-2 text-xs text-slate-500 text-center">
                    No assignees found
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </div>
      
      <div class="flex items-center gap-4">
        <div class="flex items-center gap-1.5 cursor-pointer hover:bg-slate-100 px-2 py-1 rounded transition-colors" 
             *ngIf="commentsCount > 0"
             (click)="onCommentsClick($event)"
             title="View comments">
          <svg class="w-4 h-4 text-slate-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 2c-2.236 0-4.43.18-6.57.524C1.993 2.755 1 4.014 1 5.426v5.148c0 1.413.993 2.67 2.43 2.902.848.137 1.705.248 2.57.331v3.443a.75.75 0 001.28.53l3.58-3.579a.78.78 0 01.527-.224 41.202 41.202 0 005.183-.5c1.437-.232 2.43-1.49 2.43-2.903V5.426c0-1.413-.993-2.67-2.43-2.902A41.289 41.289 0 0010 2zm0 7a1 1 0 100-2 1 1 0 000 2zM8 8a1 1 0 11-2 0 1 1 0 012 0zm5 1a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
          </svg>
          <span class="text-xs font-medium text-slate-600">{{ commentsCount }}</span>
        </div>
        
        <!-- Due Date -->
        <div class="relative">
          <button
            type="button"
            (click)="onDueDateClick($event)"
            class="flex items-center gap-1.5 cursor-pointer hover:bg-slate-100 px-2 py-1 rounded transition-colors"
            [title]="'Due date: ' + (issue.dueDate ? (issue.dueDate | date:'MMM d, yyyy') : 'Not set') + ' (click to change)'">
            <svg class="w-4 h-4 text-slate-400" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M5.75 2a.75.75 0 01.75.75V4h7V2.75a.75.75 0 011.5 0V4h.25A2.75 2.75 0 0118 6.75v8.5A2.75 2.75 0 0115.25 18H4.75A2.75 2.75 0 012 15.25v-8.5A2.75 2.75 0 014.75 4H5V2.75A.75.75 0 015.75 2zm-1 5.5c-.69 0-1.25.56-1.25 1.25v6.5c0 .69.56 1.25 1.25 1.25h10.5c.69 0 1.25-.56 1.25-1.25v-6.5c0-.69-.56-1.25-1.25-1.25H4.75z" clip-rule="evenodd"/>
            </svg>
            <span class="text-xs font-medium text-slate-600">
              {{ issue.dueDate ? (issue.dueDate | date:'MMM d') : 'No due date' }}
            </span>
          </button>
          
          <!-- Date Picker Dropdown -->
          @if (showDatePicker()) {
            <div class="absolute z-50 mt-1 right-0 bg-white rounded-lg shadow-xl border border-slate-200 p-3 min-w-[200px]"
                 appClickOutside
                 (outsideClick)="closeDatePicker()"
                 (click)="$event.stopPropagation()">
              <div class="text-xs font-semibold text-slate-500 mb-2">Set Due Date</div>
              <input
                type="date"
                [value]="formatDateForInput(issue.dueDate)"
                (change)="onDateChange($event)"
                class="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500" />
              @if (issue.dueDate) {
                <button
                  type="button"
                  (click)="clearDueDate()"
                  class="w-full mt-2 px-3 py-1.5 text-xs text-red-600 hover:bg-red-50 rounded transition-colors cursor-pointer">
                  Clear due date
                </button>
              }
            </div>
          }
        </div>
      </div>
    </div>
  </div>
</div>