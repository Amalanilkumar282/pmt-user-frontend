<div class="bg-gray-100 min-h-screen">
  <div class="mt-5 bg-white rounded-lg shadow-md w-full max-w-[1800px] mx-auto">
    
    <!-- Timeline Header Component -->
    <app-timeline-header
      [currentView]="currentView"
      [displayMode]="displayMode"
      [selectedFilters]="selectedFilters"
      [availableSprints]="availableSprints"
      [availableEpics]="availableEpics"
      [selectedEpic]="selectedEpic"
      (viewChanged)="onViewChanged($event)"
      (filterToggled)="onFilterToggled($event)"
      (filtersCleared)="onFiltersCleared()"
      (backToEpics)="onBackToEpics()">
    </app-timeline-header>
    
    <!-- Gantt Container - DYNAMIC HEIGHT -->
    <div class="timeline-container" 
         [style.height.px]="getContainerHeight()"
         #chartContainer>
      
      <!-- Left Sidebar - Task List -->
      <div class="timeline-sidebar">
        <!-- FIXED: Sidebar Header with dynamic height based on view -->
        <div class="sidebar-header"
             [class.day-view]="currentView === 'day'"
             [class.month-view]="currentView === 'month'"
             [class.year-view]="currentView === 'year'">
          <div class="flex items-center gap-2">
            <span class="text-base font-semibold text-indigo-800">Tasks</span>
          </div>
        </div>

        <!-- Timeline Rows (Scrollable Content) -->
        <div class="sidebar-content" #sidebarContent (scroll)="onSidebarScroll($event)">
          <ng-container *ngFor="let row of timelineRows">
            <div *ngIf="row.visible !== false"
                 class="timeline-row"
                 [class.sprint-row]="row.type === 'sprint'"
                 [class.epic-row]="row.type === 'epic'"
                 [class.issue-row]="row.type === 'issue'">
              
              <!-- Sprint Row -->
              <div *ngIf="row.type === 'sprint'" 
                   class="row-content sprint-content"
                   (click)="toggleRow(row.id)">
                <span class="font-medium text-sm flex-1 truncate">{{ row.name }}</span>
                <span class="px-1.5 py-0.5 text-xs rounded font-medium text-white"
                      [ngClass]="getStatusBadgeClass(row.status)">
                  {{ row.progress }}%
                </span>
              </div>

              <!-- Epic Row -->
              <div *ngIf="row.type === 'epic'" 
                   class="row-content epic-content"
                   (click)="toggleRow(row.id)">
                <button class="w-4 h-4 flex items-center justify-center text-gray-500 hover:text-gray-700 ml-2">
                  <svg *ngIf="isRowExpanded(row.id)" 
                       width="12" height="12" viewBox="0 0 24 24" fill="none" 
                       class="transition-transform duration-200">
                    <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <svg *ngIf="!isRowExpanded(row.id)" 
                       width="12" height="12" viewBox="0 0 24 24" fill="none" 
                       class="transition-transform duration-200 -rotate-90">
                    <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                <span class="w-5 h-5 bg-purple-100 rounded flex items-center justify-center flex-shrink-0">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8 2l2 4h4l-3 3 1 4-4-2-4 2 1-4-3-3h4z" stroke="#a855f7" stroke-width="1.5" fill="none" stroke-linejoin="round"/>
                  </svg>
                </span>
                <span class="text-sm font-medium text-gray-700 flex-1 truncate">{{ row.name }}</span>
                <span class="px-1.5 py-0.5 text-xs rounded font-medium text-white"
                      [ngClass]="getStatusBadgeClass(row.status)">
                  {{ row.progress }}%
                </span>
              </div>

              <!-- Issue Row -->
              <div *ngIf="row.type === 'issue'" 
                   class="row-content issue-content">
                <div class="flex items-center gap-1.5 w-full">
                  <!-- Story Icon -->
                  <svg *ngIf="row.issueType === 'STORY'" class="flex-shrink-0" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="2" y="2" width="12" height="12" rx="2" stroke="#10b981" stroke-width="1.5" fill="none"/>
                    <path d="M5 6h6M5 8h6M5 10h4" stroke="#10b981" stroke-width="1.5" stroke-linecap="round"/>
                  </svg>
                  <!-- Task Icon -->
                  <svg *ngIf="row.issueType === 'TASK'" class="flex-shrink-0" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="2" y="2" width="12" height="12" rx="2" stroke="#3b82f6" stroke-width="1.5" fill="none"/>
                    <path d="M5 8l2 2 4-4" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <!-- Bug Icon -->
                  <svg *ngIf="row.issueType === 'BUG'" class="flex-shrink-0" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="8" cy="8" r="6" stroke="#ef4444" stroke-width="1.5" fill="none"/>
                    <path d="M5.5 6.5L10.5 11.5M10.5 6.5L5.5 11.5" stroke="#ef4444" stroke-width="1.5" stroke-linecap="round"/>
                  </svg>
                  <!-- Epic Icon -->
                  <svg *ngIf="row.issueType === 'EPIC'" class="flex-shrink-0" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8 2l2 4h4l-3 3 1 4-4-2-4 2 1-4-3-3h4z" stroke="#a855f7" stroke-width="1.5" fill="none" stroke-linejoin="round"/>
                  </svg>
                  <!-- Default Icon -->
                  <svg *ngIf="!row.issueType || (row.issueType !== 'STORY' && row.issueType !== 'TASK' && row.issueType !== 'BUG' && row.issueType !== 'EPIC')" 
                       class="flex-shrink-0" width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <circle cx="8" cy="8" r="5" stroke="#6b7280" stroke-width="1.5" fill="none"/>
                  </svg>
                  <span class="text-xs text-gray-600 truncate max-w-[70px]">{{ row.id }}</span>
                  <span class="text-sm text-gray-800 flex-1 truncate">{{ row.name }}</span>
                  <span class="px-1.5 py-0.5 text-xs rounded text-white"
                        [ngClass]="getStatusBadgeClass(row.status)">
                    {{ row.progress }}%
                  </span>
                </div>
              </div>
            </div>
          </ng-container>
        </div>
      </div>

      <!-- Right Side - Gantt Chart -->
      <div class="timeline-chart">
        <!-- FIXED: Timeline Header with dynamic height based on view -->
        <div class="chart-header"
             [class.day-view]="currentView === 'day'"
             [class.month-view]="currentView === 'month'"
             [class.year-view]="currentView === 'year'">
          <div class="header-scroll-container" #headerScroll (scroll)="onHeaderScroll($event)">
            <div class="header-content" [style.width.px]="chartWidth">
              
              <!-- Month/Year Headers (Top Level) - ALWAYS VISIBLE -->
              <div class="header-level month-header">
                <div *ngFor="let header of monthHeaders" 
                     class="header-cell month-cell"
                     [style.left.px]="header.left"
                     [style.width.px]="header.width">
                  <div class="text-xs font-semibold text-gray-700 px-2">{{ header.name }}</div>
                </div>
              </div>
              
              <!-- Week Headers (Middle Level) - VISIBLE for day and month views -->
              <div *ngIf="currentView !== 'year'" 
                   class="header-level week-header">
                <div *ngFor="let week of weekHeaders"
                     class="header-cell week-cell"
                     [style.left.px]="week.left"
                     [style.width.px]="week.width">
                  {{ week.name }}
                </div>
              </div>

              <!-- Day Headers (Bottom Level) - VISIBLE for day view only -->
              <div *ngIf="currentView === 'day'" 
                   class="header-level day-header">
                <div *ngFor="let day of dayHeaders"
                     class="header-cell day-cell"
                     [style.left.px]="day.left"
                     [style.width.px]="day.width">
                  {{ day.name }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Chart Content Area (Scrollable) -->
        <div class="chart-content" #chartContent (scroll)="onChartScroll($event)">
          <!-- Chart Canvas -->
          <div class="chart-canvas" [style.min-width.px]="chartWidth" [style.width.px]="chartWidth">
            <!-- Grid Lines (Behind content) -->
            <div class="chart-grid">
              <div *ngFor="let header of monthHeaders; let i = index"
                   class="grid-line"
                   [class.major]="i % 3 === 0"
                   [style.left.px]="header.left">
              </div>
            </div>

            <!-- Timeline Rows with Bars -->
            <div class="chart-rows">
              <ng-container *ngFor="let row of timelineRows">
                <div *ngIf="row.visible !== false"
                     class="chart-row"
                     [class.sprint-row]="row.type === 'sprint'"
                     [class.epic-row]="row.type === 'epic'"
                     [class.issue-row]="row.type === 'issue'">
                  
                  <!-- Sprint Bar -->
                  <div *ngIf="row.type === 'sprint' && row.startDate && row.endDate" 
                       class="timeline-bar sprint-bar"
                       [class.resizing]="resizingBar?.id === row.id"
                       [style.left.px]="getBarPosition(row.startDate)"
                       [style.width.px]="getBarWidth(row.startDate, row.endDate)"
                       [title]="row.name + ' (' + row.progress + '%)'">
                    <div class="bar-resize-handle left" 
                         (mousedown)="onBarResizeStart($event, row, 'left')"></div>
                    <div class="bar-label">
                      {{ row.name }} ({{ row.progress }}%)
                    </div>
                    <div class="bar-resize-handle right" 
                         (mousedown)="onBarResizeStart($event, row, 'right')"></div>
                  </div>

                  <!-- Epic Bar -->
                  <div *ngIf="row.type === 'epic' && row.startDate && row.endDate" 
                       class="timeline-bar epic-bar"
                       [class.resizing]="resizingBar?.id === row.id"
                       [style.left.px]="getBarPosition(row.startDate)"
                       [style.width.px]="getBarWidth(row.startDate, row.endDate)"
                       [title]="row.name + ' (' + row.progress + '%)'">
                    <div class="bar-resize-handle left" 
                         (mousedown)="onBarResizeStart($event, row, 'left')"></div>
                    <div class="bar-label">
                      {{ row.name }} ({{ row.progress }}%)
                    </div>
                    <div class="bar-resize-handle right" 
                         (mousedown)="onBarResizeStart($event, row, 'right')"></div>
                  </div>

                  <!-- Issue Bar -->
                  <div *ngIf="row.type === 'issue' && row.startDate && row.endDate" 
                       class="timeline-bar issue-bar"
                       [class.resizing]="resizingBar?.id === row.id"
                       [style.left.px]="getBarPosition(row.startDate)"
                       [style.width.px]="getBarWidth(row.startDate, row.endDate)"
                       [title]="row.name + ' (' + row.progress + '%)'">
                    <div class="bar-resize-handle left" 
                         (mousedown)="onBarResizeStart($event, row, 'left')"></div>
                    <div class="bar-label">
                      {{ row.progress }}%
                    </div>
                    <div class="bar-resize-handle right" 
                         (mousedown)="onBarResizeStart($event, row, 'right')"></div>
                  </div>
                </div>
              </ng-container>
            </div>

            <!-- Today Marker (Above content) -->
            <div *ngIf="getTodayPosition() >= 0 && getTodayPosition() <= chartWidth"
                 class="today-marker"
                 [style.left.px]="getTodayPosition()">
              <div class="today-dot"></div>
              <div class="today-label">
                Today
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>