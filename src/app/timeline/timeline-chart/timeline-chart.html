<div class="bg-gray-100 min-h-screen">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="flex items-center justify-center min-h-[500px]">
    <div class="text-center">
      <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-indigo-600 mx-auto mb-4"></div>
      <p class="text-gray-600 text-lg font-medium">Loading timeline data...</p>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="errorMessage && !isLoading" class="flex items-center justify-center min-h-[500px]">
    <div class="text-center bg-red-50 border-2 border-red-300 rounded-lg p-8 max-w-md mx-auto">
      <svg class="w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <h3 class="text-xl font-semibold text-red-800 mb-2">Error Loading Timeline</h3>
      <p class="text-red-600">{{ errorMessage }}</p>
      <button 
        (click)="projectId && loadTimelineData(projectId)" 
        class="mt-4 px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
        Retry
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading && !errorMessage" class="mt-5 bg-white rounded-lg shadow-md w-full max-w-[1800px] mx-auto">
    
    <!-- Timeline Header Component -->
    <app-timeline-header
      [currentView]="currentView"
      [displayMode]="displayMode"
      [selectedFilters]="selectedFilters"
      [availableEpics]="availableEpics"
      [selectedEpic]="selectedEpic"
      (viewChanged)="onViewChanged($event)"
      (filterToggled)="onFilterToggled($event)"
      (filtersCleared)="onFiltersCleared()"
      (backToEpics)="onBackToEpics()"
      (displayRangeChanged)="onDisplayRangeChanged($event)"
      (showCompletedChanged)="onShowCompletedChanged($event)"
      (expandAllEpics)="onExpandAllEpics()"
      (collapseAllEpics)="onCollapseAllEpics()">
    </app-timeline-header>
    
    <!-- Gantt Container - DYNAMIC HEIGHT -->
    <div class="timeline-container" 
         [style.height.px]="getContainerHeight()"
         #chartContainer>
      
      <!-- Left Sidebar - Task List -->
      <div class="timeline-sidebar">
        <!-- FIXED: Sidebar Header with dynamic height based on view -->
        <div class="sidebar-header"
             [class.day-view]="currentView === 'day'"
             [class.month-view]="currentView === 'month'"
             [class.year-view]="currentView === 'year'">
          <div class="flex items-center gap-2">
            <span class="text-base font-semibold text-indigo-800">Tasks</span>
          </div>
        </div>

        <!-- Timeline Rows (Scrollable Content) -->
        <div class="sidebar-content" #sidebarContent (scroll)="onSidebarScroll($event)">
          <ng-container *ngFor="let row of timelineRows">
            <div *ngIf="row.visible !== false"
                 class="timeline-row"
                 [class.sprint-row]="row.type === 'sprints-overview'"
                 [class.epic-row]="row.type === 'epic'"
                 [class.issue-row]="row.type === 'issue'">
              
              <!-- Sprints Overview Row (non-expandable) -->
              <div *ngIf="row.type === 'sprints-overview'" 
                   class="row-content sprint-content">
                <span class="font-medium text-sm flex-1 truncate">{{ row.name }}</span>
              </div>

              <!-- Epic Row -->
              <div *ngIf="row.type === 'epic'" 
                   class="row-content epic-content">
                <button class="w-4 h-4 flex items-center justify-center text-gray-500 hover:text-gray-700 ml-2"
                        (click)="toggleRow(row.id)">
                  <svg *ngIf="isRowExpanded(row.id)" 
                       width="12" height="12" viewBox="0 0 24 24" fill="none" 
                       class="transition-transform duration-200">
                    <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <svg *ngIf="!isRowExpanded(row.id)" 
                       width="12" height="12" viewBox="0 0 24 24" fill="none" 
                       class="transition-transform duration-200 -rotate-90">
                    <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                <div class="flex items-center flex-1 gap-2 cursor-pointer hover:bg-purple-50 transition-colors rounded px-2 py-1"
                     (click)="onEpicClick($event, row.id)">
                  <span class="w-5 h-5 flex items-center justify-center flex-shrink-0">
                    <i class="fa-solid fa-bolt text-gray-600"></i>
                  </span>
                  <span class="text-sm font-medium text-gray-700 flex-1 truncate">{{ row.name }}</span>
                  <span class="px-1.5 py-0.5 text-xs rounded font-medium text-white"
                        [ngClass]="getStatusBadgeClass(row.status)">
                    {{ getStatusLabel(row.status) }}
                  </span>
                </div>
              </div>

              <!-- Issue Row -->
              <div *ngIf="row.type === 'issue'" 
                   class="row-content issue-content cursor-pointer hover:bg-blue-50 transition-colors rounded px-2 py-1"
                   (click)="onIssueClick($event, row.id)">
                <div class="flex items-center gap-1.5 w-full">
                  <!-- Story Icon -->
                  <i *ngIf="row.issueType === 'STORY'" class="fa-solid fa-book text-gray-600"></i>
                  <!-- Task Icon -->
                  <i *ngIf="row.issueType === 'TASK'" class="fa-solid fa-check-circle text-gray-600"></i>
                  <!-- Bug Icon -->
                  <i *ngIf="row.issueType === 'BUG'" class="fa-solid fa-bug text-gray-600"></i>
                  <!-- Epic Icon -->
                  <i *ngIf="row.issueType === 'EPIC'" class="fa-solid fa-bolt text-gray-600"></i>
                  <!-- Default Icon -->
                  <svg *ngIf="!row.issueType || (row.issueType !== 'STORY' && row.issueType !== 'TASK' && row.issueType !== 'BUG' && row.issueType !== 'EPIC')" 
                       class="flex-shrink-0" width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <circle cx="8" cy="8" r="5" stroke="#6b7280" stroke-width="1.5" fill="none"/>
                  </svg>
                  <span class="text-xs font-semibold text-indigo-600 truncate max-w-[70px]">{{ row.issueKey || 'N/A' }}</span>
                  <span class="text-sm text-gray-800 flex-1 truncate">{{ row.name }}</span>
                  <span class="px-1.5 py-0.5 text-xs rounded text-white"
                        [ngClass]="getStatusBadgeClass(row.status)">
                    {{ getStatusLabel(row.status) }}
                  </span>
                </div>
              </div>
            </div>
          </ng-container>
        </div>
      </div>

      <!-- Right Side - Gantt Chart -->
      <div class="timeline-chart">
        <!-- FIXED: Timeline Header with dynamic height based on view -->
        <div class="chart-header"
             [class.day-view]="currentView === 'day'"
             [class.month-view]="currentView === 'month'"
             [class.year-view]="currentView === 'year'">
          <div class="header-scroll-container" #headerScroll (scroll)="onHeaderScroll($event)">
            <div class="header-content" [style.width.px]="chartWidth">
              
              <!-- Year Headers (Top Level) - VISIBLE for year view only -->
              <div *ngIf="currentView === 'year'" 
                   class="header-level year-header">
                <div *ngFor="let year of yearHeaders"
                     class="header-cell year-cell"
                     [style.left.px]="year.left"
                     [style.width.px]="year.width">
                  {{ year.name }}
                </div>
              </div>
              
              <!-- Month Headers (Top/Mid Level) - ALWAYS VISIBLE -->
              <div class="header-level month-header">
                <div *ngFor="let header of monthHeaders" 
                     class="header-cell month-cell"
                     [style.left.px]="header.left"
                     [style.width.px]="header.width">
                  <div class="text-xs font-semibold text-gray-700 px-2">{{ header.name }}</div>
                </div>
              </div>

              <!-- Day Headers (Bottom Level) - VISIBLE for day view only -->
              <div *ngIf="currentView === 'day'" 
                   class="header-level day-header">
                <div *ngFor="let day of dayHeaders"
                     class="header-cell day-cell"
                     [style.left.px]="day.left"
                     [style.width.px]="day.width">
                  {{ day.name }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Chart Content Area (Scrollable) -->
        <div class="chart-content" 
             #chartContent 
             (scroll)="onChartScroll($event)">
          <!-- Chart Canvas -->
          <div class="chart-canvas" [style.min-width.px]="chartWidth" [style.width.px]="chartWidth">
            <!-- Grid Lines (Behind content) -->
            <div class="chart-grid">
              <div *ngFor="let header of monthHeaders; let i = index"
                   class="grid-line"
                   [class.major]="i % 3 === 0"
                   [style.left.px]="header.left">
              </div>
            </div>

            <!-- Timeline Rows with Bars -->
            <div class="chart-rows">
              <ng-container *ngFor="let row of timelineRows">
                <div *ngIf="row.visible !== false"
                     class="chart-row"
                     [class.sprint-row]="row.type === 'sprints-overview'"
                     [class.epic-row]="row.type === 'epic'"
                     [class.issue-row]="row.type === 'issue'">
                  
                  <!-- Sprints Overview Row - Multiple Sprint Bars (only show sprints with valid dates) -->
                  <ng-container *ngIf="row.type === 'sprints-overview' && row.sprints">
                    <div *ngFor="let sprint of row.sprints" 
                         class="timeline-bar sprint-bar"
                         [style.left.px]="sprint.startDate && sprint.endDate ? getBarPosition(sprint.startDate) : 0"
                         [style.width.px]="sprint.startDate && sprint.endDate ? getBarWidth(sprint.startDate, sprint.endDate) : 0"
                         [style.display]="sprint.startDate && sprint.endDate ? 'block' : 'none'"
                         [title]="sprint.startDate && sprint.endDate ? getTooltipText(sprint.name, sprint.startDate, sprint.endDate) : ''">
                      <div class="bar-label">
                        {{ sprint.name }}
                      </div>
                    </div>
                  </ng-container>

                  <!-- Epic Bar -->
                  <div *ngIf="row.type === 'epic' && row.startDate && row.endDate" 
                       class="timeline-bar epic-bar"
                       [class.resizing]="resizingBar?.id === row.id"
                       [style.left.px]="getBarPosition(row.startDate)"
                       [style.width.px]="getBarWidth(row.startDate, row.endDate)"
                       [title]="getTooltipText(row.name, row.startDate, row.endDate)"
                       (click)="onEpicClick($event, row.id)">
                    <div class="bar-resize-handle left" 
                         (mousedown)="onBarResizeStart($event, row, 'left')"></div>
                    <div class="bar-resize-handle right" 
                         (mousedown)="onBarResizeStart($event, row, 'right')"></div>
                  </div>

                  <!-- Issue Bar -->
                  <div *ngIf="row.type === 'issue' && row.startDate && row.endDate" 
                       class="timeline-bar issue-bar"
                       [class.resizing]="resizingBar?.id === row.id"
                       [style.left.px]="getBarPosition(row.startDate)"
                       [style.width.px]="getBarWidth(row.startDate, row.endDate)"
                       [title]="getTooltipText(row.name, row.startDate, row.endDate)"
                       (click)="onIssueClick($event, row.id)">
                    <div class="bar-resize-handle left" 
                         (mousedown)="onBarResizeStart($event, row, 'left')"></div>
                    <div class="bar-resize-handle right" 
                         (mousedown)="onBarResizeStart($event, row, 'right')"></div>
                  </div>
                </div>
              </ng-container>
            </div>

            <!-- Today Marker (Above content) -->
            <div *ngIf="getTodayPosition() >= 0 && getTodayPosition() <= chartWidth"
                 class="today-marker"
                 [style.left.px]="getTodayPosition()">
              <div class="today-dot"></div>
              <div class="today-label">
                Today
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Epic Detailed View Side Panel -->
  @if (isEpicModalOpen && selectedEpicForModal) {
    <div class="epic-detail-overlay" (click)="closeEpicModal()">
      <div class="epic-detail-side-panel" (click)="$event.stopPropagation()">
        <app-epic-detailed-view 
          [epic]="selectedEpicForModal" 
          (close)="closeEpicModal()" 
          (epicUpdated)="onEpicUpdated($event)">
        </app-epic-detailed-view>
      </div>
    </div>
  }

  <!-- Issue Detailed View Modal -->
  <app-issue-detailed-view 
    [issue]="selectedIssueForModal"
    [isOpen]="isIssueModalOpen"
    (close)="closeIssueModal()" 
    (deleteIssue)="onIssueDeleted($event)">
  </app-issue-detailed-view>

</div> <!-- End of bg-gray-100 wrapper -->