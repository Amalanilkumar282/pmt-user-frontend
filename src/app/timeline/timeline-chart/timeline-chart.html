<div class="timeline-chart-wrapper">
  <div class="mt-5 bg-white rounded-lg shadow-md w-full max-w-[1800px] mx-auto">
    
    <!-- Timeline Header Component -->
    <app-timeline-header
      [currentView]="currentView"
      [displayMode]="displayMode"
      [selectedFilters]="selectedFilters"
      [availableSprints]="availableSprints"
      [availableEpics]="availableEpics"
      [selectedEpic]="selectedEpic"
      (viewChanged)="onViewChanged($event)"
      (filterToggled)="onFilterToggled($event)"
      (filtersCleared)="onFiltersCleared()"
      (backToEpics)="onBackToEpics()"
      (displayRangeChanged)="onDisplayRangeChanged($event)"
      (showCompletedChanged)="onShowCompletedChanged($event)"
      (expandAllEpics)="onExpandAllEpics()"
      (collapseAllEpics)="onCollapseAllEpics()">
    </app-timeline-header>
    
    <!-- Gantt Container - DYNAMIC HEIGHT -->
    <div class="timeline-container" 
         [style.height.px]="getContainerHeight()">
      
      <!-- Left Sidebar - Task List -->
      <div class="timeline-sidebar" #chartContainer>
        <!-- Sidebar Header with consistent height -->
        <div class="sidebar-header">
          <div class="flex items-center gap-2">
            <span class="text-base font-semibold text-indigo-800">Tasks</span>
          </div>
        </div>

        <!-- Timeline Rows (Scrollable Content) -->
        <div class="sidebar-content" #sidebarContent (scroll)="onSidebarScroll($event)">
          <ng-container *ngFor="let row of timelineRows">
            <div *ngIf="row.visible !== false"
                 class="timeline-row"
                 [class.sprint-row]="row.type === 'sprint'"
                 [class.epic-row]="row.type === 'epic'"
                 [class.issue-row]="row.type === 'issue'">
              
              <!-- Sprint Row -->
              <div *ngIf="row.type === 'sprint'" 
                   class="row-content sprint-content"
                   (click)="toggleRow(row.id)">
                <span class="font-medium text-sm flex-1 truncate">{{ row.name }}</span>
                <span class="px-1.5 py-0.5 text-xs rounded font-medium text-white"
                      [ngClass]="getStatusBadgeClass(row.status)">
                  {{ getStatusLabel(row.status) }}
                </span>
              </div>

              <!-- Epic Row -->
              <div *ngIf="row.type === 'epic'" 
                   class="row-content epic-content">
                <button class="w-4 h-4 flex items-center justify-center text-gray-500 hover:text-gray-700 ml-2"
                        (click)="toggleRow(row.id)">
                  <svg *ngIf="isRowExpanded(row.id)" 
                       width="12" height="12" viewBox="0 0 24 24" fill="none" 
                       class="transition-transform duration-200">
                    <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <svg *ngIf="!isRowExpanded(row.id)" 
                       width="12" height="12" viewBox="0 0 24 24" fill="none" 
                       class="transition-transform duration-200 -rotate-90">
                    <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                <div class="flex items-center flex-1 gap-2 cursor-pointer hover:bg-gray-50 transition-colors rounded px-2 py-1"
                     (click)="onEpicClick($event, row.id)">
                  <span class="w-5 h-5 bg-gray-100 rounded flex items-center justify-center flex-shrink-0">
                    <i class="fa-solid fa-bolt text-black"></i>
                  </span>
                  <span class="text-sm font-medium text-gray-700 flex-1 truncate">{{ row.name }}</span>
                  <span class="px-1.5 py-0.5 text-xs rounded font-medium text-white"
                        [ngClass]="getStatusBadgeClass(row.status)">
                    {{ getStatusLabel(row.status) }}
                  </span>
                </div>
              </div>

              <!-- Issue Row -->
              <div *ngIf="row.type === 'issue'" 
                   class="row-content issue-content cursor-pointer hover:bg-blue-50 transition-colors rounded px-2 py-1"
                   (click)="onIssueClick($event, row.id)">
                <div class="flex items-center gap-1.5 w-full">
                  <i class="flex-shrink-0 w-4 h-4 text-center" [ngClass]="getTypeIcon(row.issueType || '')"></i>
                  <span class="text-xs text-gray-600 truncate max-w-[70px]">{{ row.id }}</span>
                  <span class="text-sm text-gray-800 flex-1 truncate">{{ row.name }}</span>
                  <span class="px-1.5 py-0.5 text-xs rounded text-white"
                        [ngClass]="getStatusBadgeClass(row.status)">
                    {{ getStatusLabel(row.status) }}
                  </span>
                </div>
              </div>
            </div>
          </ng-container>
        </div>
      </div>

      <!-- Right Side - DHTMLX Gantt Chart -->
      <div class="timeline-chart">
        <div class="gantt-container" #ganttContainer></div>
      </div>
    </div>
  </div>
</div>
<!-- Epic Detailed View Side Panel -->
@if (isEpicModalOpen && selectedEpicForModal) {
  <div class="epic-detail-overlay" (click)="closeEpicModal()">
    <div class="epic-detail-side-panel" (click)="$event.stopPropagation()">
      <app-epic-detailed-view 
        [epic]="selectedEpicForModal" 
        (close)="closeEpicModal()" 
        (epicUpdated)="onEpicUpdated($event)">
      </app-epic-detailed-view>
    </div>
  </div>
}

<!-- Issue Detailed View Modal -->
<app-issue-detailed-view 
  [issue]="selectedIssueForModal"
  [isOpen]="isIssueModalOpen"
  (close)="closeIssueModal()" 
  (deleteIssue)="onIssueDeleted($event)">
</app-issue-detailed-view>
