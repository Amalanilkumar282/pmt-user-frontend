<div class="bg-gray-100 min-h-screen">
  <div class="mt-5 bg-white rounded-lg shadow-md w-full max-w-[1800px] mx-auto">
    
    <!-- Timeline Header Component -->
    <app-timeline-header
      [currentView]="currentView"
      [displayMode]="displayMode"
      [selectedFilters]="selectedFilters"
      [availableSprints]="availableSprints"
      [availableEpics]="availableEpics"
      [selectedEpic]="selectedEpic"
      (viewChanged)="onViewChanged($event)"
      (filterToggled)="onFilterToggled($event)"
      (filtersCleared)="onFiltersCleared()"
      (backToEpics)="onBackToEpics()">
    </app-timeline-header>
    
    <!-- Gantt Container - DYNAMIC HEIGHT -->
    <div class="timeline-container" 
         [style.height.px]="getContainerHeight()"
         #chartContainer>
      
      <!-- Left Sidebar - Task List -->
      <div class="timeline-sidebar">
        <!-- FIXED: Sidebar Header with dynamic height based on view -->
        <div class="sidebar-header"
             [class.day-view]="currentView === 'day'"
             [class.month-view]="currentView === 'month'"
             [class.year-view]="currentView === 'year'">
          <div class="flex items-center gap-2">
            <span class="text-sm font-semibold text-indigo-800">Tasks</span>
          </div>
        </div>

        <!-- Timeline Rows (Scrollable Content) -->
        <div class="sidebar-content" #sidebarContent (scroll)="onSidebarScroll($event)">
          <ng-container *ngFor="let row of timelineRows">
            <div *ngIf="row.visible !== false"
                 class="timeline-row"
                 [class.sprint-row]="row.type === 'sprint'"
                 [class.epic-row]="row.type === 'epic'"
                 [class.issue-row]="row.type === 'issue'">
              
              <!-- Sprint Row -->
              <div *ngIf="row.type === 'sprint'" 
                   class="row-content sprint-content"
                   (click)="toggleRow(row.id)">
                <span class="w-5 h-5 bg-indigo-100 rounded flex items-center justify-center text-indigo-700 text-xs">üèÉ</span>
                <span class="font-medium text-xs flex-1 truncate">{{ row.name }}</span>
                <span class="px-1.5 py-0.5 text-xs rounded font-medium text-white"
                      [ngClass]="getStatusBadgeClass(row.status)">
                  {{ row.progress }}%
                </span>
              </div>

              <!-- Epic Row -->
              <div *ngIf="row.type === 'epic'" 
                   class="row-content epic-content"
                   (click)="toggleRow(row.id)">
                <button class="w-4 h-4 flex items-center justify-center text-gray-500 hover:text-gray-700 ml-2 text-xs">
                  <span *ngIf="isRowExpanded(row.id)">‚ñº</span>
                  <span *ngIf="!isRowExpanded(row.id)">‚ñ∂</span>
                </button>
                <span class="w-5 h-5 bg-purple-100 rounded flex items-center justify-center text-purple-700 text-xs font-bold">‚ö°</span>
                <span class="text-xs font-medium text-gray-700 flex-1 truncate">{{ row.name }}</span>
                <span class="px-1.5 py-0.5 text-xs rounded font-medium text-white"
                      [ngClass]="getStatusBadgeClass(row.status)">
                  {{ row.progress }}%
                </span>
              </div>

              <!-- Issue Row -->
              <div *ngIf="row.type === 'issue'" 
                   class="row-content issue-content">
                <div class="flex items-center gap-1.5 w-full">
                  <span class="text-xs">{{ getTypeIcon(row.issueType) }}</span>
                  <span class="text-xs text-gray-600 truncate max-w-[60px]">{{ row.id }}</span>
                  <span class="text-xs text-gray-800 flex-1 truncate">{{ row.name }}</span>
                  <span class="px-1.5 py-0.5 text-xs rounded text-white"
                        [ngClass]="getStatusBadgeClass(row.status)">
                    {{ row.progress }}%
                  </span>
                </div>
              </div>
            </div>
          </ng-container>
        </div>
      </div>

      <!-- Right Side - Gantt Chart -->
      <div class="timeline-chart">
        <!-- FIXED: Timeline Header with dynamic height based on view -->
        <div class="chart-header"
             [class.day-view]="currentView === 'day'"
             [class.month-view]="currentView === 'month'"
             [class.year-view]="currentView === 'year'">
          <div class="header-scroll-container" #headerScroll (scroll)="onHeaderScroll($event)">
            <div class="header-content" [style.width.px]="chartWidth">
              
              <!-- Month/Year Headers (Top Level) - ALWAYS VISIBLE -->
              <div class="header-level month-header">
                <div *ngFor="let header of monthHeaders" 
                     class="header-cell month-cell"
                     [style.left.px]="header.left"
                     [style.width.px]="header.width">
                  <div class="text-xs font-semibold text-gray-700 px-2">{{ header.name }}</div>
                </div>
              </div>
              
              <!-- Week Headers (Middle Level) - VISIBLE for day and month views -->
              <div *ngIf="currentView !== 'year'" 
                   class="header-level week-header">
                <div *ngFor="let week of weekHeaders"
                     class="header-cell week-cell"
                     [style.left.px]="week.left"
                     [style.width.px]="week.width">
                  {{ week.name }}
                </div>
              </div>

              <!-- Day Headers (Bottom Level) - VISIBLE for day view only -->
              <div *ngIf="currentView === 'day'" 
                   class="header-level day-header">
                <div *ngFor="let day of dayHeaders"
                     class="header-cell day-cell"
                     [style.left.px]="day.left"
                     [style.width.px]="day.width">
                  {{ day.name }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Chart Content Area (Scrollable) -->
        <div class="chart-content" #chartContent (scroll)="onChartScroll($event)">
          <!-- Chart Canvas -->
          <div class="chart-canvas" [style.min-width.px]="chartWidth" [style.width.px]="chartWidth">
            <!-- Grid Lines (Behind content) -->
            <div class="chart-grid">
              <div *ngFor="let header of monthHeaders; let i = index"
                   class="grid-line"
                   [class.major]="i % 3 === 0"
                   [style.left.px]="header.left">
              </div>
            </div>

            <!-- Timeline Rows with Bars -->
            <div class="chart-rows">
              <ng-container *ngFor="let row of timelineRows">
                <div *ngIf="row.visible !== false"
                     class="chart-row"
                     [class.sprint-row]="row.type === 'sprint'"
                     [class.epic-row]="row.type === 'epic'"
                     [class.issue-row]="row.type === 'issue'">
                  
                  <!-- Sprint Bar -->
                  <div *ngIf="row.type === 'sprint' && row.startDate && row.endDate" 
                       class="timeline-bar sprint-bar"
                       [class.resizing]="resizingBar?.id === row.id"
                       [style.left.px]="getBarPosition(row.startDate)"
                       [style.width.px]="getBarWidth(row.startDate, row.endDate)"
                       [title]="row.name + ' (' + row.progress + '%)'">
                    <div class="bar-resize-handle left" 
                         (mousedown)="onBarResizeStart($event, row, 'left')"></div>
                    <div class="bar-label">
                      {{ row.name }} ({{ row.progress }}%)
                    </div>
                    <div class="bar-resize-handle right" 
                         (mousedown)="onBarResizeStart($event, row, 'right')"></div>
                  </div>

                  <!-- Epic Bar -->
                  <div *ngIf="row.type === 'epic' && row.startDate && row.endDate" 
                       class="timeline-bar epic-bar"
                       [class.resizing]="resizingBar?.id === row.id"
                       [style.left.px]="getBarPosition(row.startDate)"
                       [style.width.px]="getBarWidth(row.startDate, row.endDate)"
                       [title]="row.name + ' (' + row.progress + '%)'">
                    <div class="bar-resize-handle left" 
                         (mousedown)="onBarResizeStart($event, row, 'left')"></div>
                    <div class="bar-label">
                      {{ row.name }} ({{ row.progress }}%)
                    </div>
                    <div class="bar-resize-handle right" 
                         (mousedown)="onBarResizeStart($event, row, 'right')"></div>
                  </div>

                  <!-- Issue Bar -->
                  <div *ngIf="row.type === 'issue' && row.startDate && row.endDate" 
                       class="timeline-bar issue-bar"
                       [class.resizing]="resizingBar?.id === row.id"
                       [style.left.px]="getBarPosition(row.startDate)"
                       [style.width.px]="getBarWidth(row.startDate, row.endDate)"
                       [title]="row.name + ' (' + row.progress + '%)'">
                    <div class="bar-resize-handle left" 
                         (mousedown)="onBarResizeStart($event, row, 'left')"></div>
                    <div class="bar-label">
                      {{ row.progress }}%
                    </div>
                    <div class="bar-resize-handle right" 
                         (mousedown)="onBarResizeStart($event, row, 'right')"></div>
                  </div>
                </div>
              </ng-container>
            </div>

            <!-- Today Marker (Above content) -->
            <div *ngIf="getTodayPosition() >= 0 && getTodayPosition() <= chartWidth"
                 class="today-marker"
                 [style.left.px]="getTodayPosition()">
              <div class="today-dot"></div>
              <div class="today-label">
                Today
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>