<div class="members-management">
  <!-- Header with Stats -->
  <div class="section-header">
    <div class="header-content">
      <h2 class="section-title">Project Members</h2>
      <p class="section-subtitle">Manage members for this project</p>
    </div>
    @if (viewMode() === 'list') {
      <button class="btn-add-member" (click)="showAddForm()" *hasPermission="'canManageUsers'">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
          <circle cx="9" cy="7" r="4"/>
          <line x1="19" y1="8" x2="19" y2="14"/>
          <line x1="22" y1="11" x2="16" y2="11"/>
        </svg>
        Add Member
      </button>
    }
  </div>

  <!-- Statistics Cards -->
  @if (viewMode() === 'list') {
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
        </div>
        <div class="stat-content">
          <div class="stat-label">Total Members</div>
          <div class="stat-value">{{ totalMembers() }}</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
        </div>
        <div class="stat-content">
          <div class="stat-label">Active Members</div>
          <div class="stat-value">{{ activeMembers() }}</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="8" x2="12" y2="12"/>
            <line x1="12" y1="16" x2="12.01" y2="16"/>
          </svg>
        </div>
        <div class="stat-content">
          <div class="stat-label">Unassigned</div>
          <div class="stat-value">{{ unassignedMembers() }}</div>
        </div>
      </div>
    </div>
  }

  <!-- Add Member Form View -->
  @if (viewMode() === 'add') {
    <div class="form-container">
      <app-add-member-form 
        (memberAdded)="handleMemberAdded()"
        (cancel)="showList()"
      />
    </div>
  }

  <!-- Members List View -->
  @if (viewMode() === 'list') {
    <div class="list-container">
      <!-- Search and Filters -->
      <div class="filters-section">
        <div class="search-box">
          <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.35-4.35"/>
          </svg>
          <input
            type="text"
            class="search-input"
            placeholder="Search members by name, email, role, or team..."
            [value]="searchQuery()"
            (input)="updateSearchQuery($event)"
          />
        </div>

        <div class="filter-buttons">
          <div class="filter-group">
            <button 
              class="filter-btn"
              [class.active]="filterStatus() === 'all'"
              (click)="setFilterStatus('all')"
            >
              All
            </button>
            <button 
              class="filter-btn"
              [class.active]="filterStatus() === 'Active'"
              (click)="setFilterStatus('Active')"
            >
              Active
            </button>
            <button 
              class="filter-btn"
              [class.active]="filterStatus() === 'Inactive'"
              (click)="setFilterStatus('Inactive')"
            >
              Inactive
            </button>
          </div>

          <div class="filter-group">
            <button 
              class="filter-btn"
              [class.active]="filterTeamStatus() === 'all'"
              (click)="setFilterTeamStatus('all')"
            >
              All Teams
            </button>
            <button 
              class="filter-btn"
              [class.active]="filterTeamStatus() === 'assigned'"
              (click)="setFilterTeamStatus('assigned')"
            >
              Assigned
            </button>
            <button 
              class="filter-btn"
              [class.active]="filterTeamStatus() === 'unassigned'"
              (click)="setFilterTeamStatus('unassigned')"
            >
              Unassigned
            </button>
          </div>
        </div>
      </div>

      <!-- Members List -->
      @if (filteredMembers().length > 0) {
        <div class="members-list">
          <div class="list-header">
            <div class="list-column member-col">Member</div>
            <div class="list-column role-col">Role</div>
            <div class="list-column status-col">Status</div>
            <div class="list-column team-col">Team</div>
            <div class="list-column joined-col">Joined</div>
            <div class="list-column actions-col">Actions</div>
          </div>
          @for (member of filteredMembers(); track member.id) {
            <app-member-card
              [member]="member"
              (changeRole)="handleChangeRole($event)"
              (removeMember)="handleRemoveMember($event)"
            />
          }
        </div>
      } @else {
        <div class="empty-state">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          <h3>No Members Found</h3>
          <p>{{ searchQuery() ? 'Try adjusting your search or filters' : 'Add members to get started' }}</p>
        </div>
      }
    </div>
  }

  <!-- Role Change Modal -->
  @if (showRoleModal()) {
    <div class="modal-overlay" (click)="closeRoleModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Change Member Role</h3>
          <button class="close-btn" (click)="closeRoleModal()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="modal-body">
          @if (selectedMemberForRoleChange()) {
            <div class="member-preview">
              <div class="member-name">{{ selectedMemberForRoleChange()!.userName }}</div>
              <div class="member-email">{{ selectedMemberForRoleChange()!.userEmail }}</div>
              <div class="current-role">
                Current Role: 
                <span class="role-badge" [style.background-color]="getRoleColor(selectedMemberForRoleChange()!.role)">
                  {{ selectedMemberForRoleChange()!.role }}
                </span>
              </div>
            </div>
          }

          <form [formGroup]="roleChangeForm" (ngSubmit)="submitRoleChange()">
            <div class="form-group">
              <label for="newRole">New Role</label>
              @if (rolesLoading()) {
                <div class="loading-message">Loading roles...</div>
              } @else {
                <select id="newRole" formControlName="roleId" class="form-select">
                  <option [value]="0" disabled>Select a role</option>
                  @for (role of availableRoles(); track role.id) {
                    <option [value]="role.id">{{ role.name }}</option>
                  }
                </select>
              }
            </div>

            <div class="modal-actions">
              <button type="button" class="btn-cancel" (click)="closeRoleModal()">
                Cancel
              </button>
              <button type="submit" class="btn-submit" [disabled]="!roleChangeForm.valid || rolesLoading()">
                Update Role
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  }
</div>
