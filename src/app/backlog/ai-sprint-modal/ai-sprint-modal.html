@if (isOpen) {
<div class="modal-backdrop" 
     (click)="onBackdropClick($event)">
  <div class="modal-container ai-sprint-modal">
    <!-- Modal Header -->
    <div class="modal-header">
      <div class="modal-title">
        @if (isStillLoading) {
          <span class="check-icon">ü§ñ</span>
          <h2>Planning...</h2>
        } @else {
          <span class="check-icon">‚úÖ</span>
          <h2>AI Sprint Plan Ready</h2>
        }
      </div>
      @if (!isStillLoading) {
        <p class="subtitle">Review and add suggested issues to your sprint</p>
      }
      <button class="close-btn" (click)="onClose()" [disabled]="isStillLoading">‚úï</button>
    </div>

    <!-- Modal Body -->
    <div class="modal-body">
      <!-- Loading State -->
      @if (isStillLoading) {
        <div class="loading-container">
          <div class="ai-loader">
            <div class="spinner"></div>
            <div class="ai-thinking-icon">ü§ñ</div>
          </div>
          <h3 class="loading-title">AI is Thinking...</h3>
          <p class="loading-text">Analyzing your backlog and team capacity</p>
          <p class="loading-subtext">This may take a few seconds</p>
          <button class="btn-skip" (click)="onClose()">Skip Suggestion</button>
        </div>
      }

      <!-- Content State -->
      @if (!isStillLoading && suggestions) {
        <div class="content-container">
          
          <!-- AI Summary Section -->
          <div class="ai-section">
            <div class="section-header">
              <span class="icon">üìÑ</span>
              <h3>AI Summary</h3>
            </div>
            <div class="summary-box">
              <p>{{ suggestions.summary }}</p>
            </div>
          </div>

          <!-- Suggested Issues Section -->
          <div class="ai-section">
            <div class="section-header between">
              <div class="left">
                <span class="icon">üìã</span>
                <h3>Suggested Issues ({{ getDisplayedIssuesCount() }})</h3>
              </div>
              <div class="total-points">
                Total Story Points: <span>{{ getTotalStoryPoints() }}</span>
              </div>
            </div>

            <div class="issues-list">
              @for (issue of displayedIssues; track issue.issueId; let i = $index) {
                <div class="issue-card" [class.selected]="isIssueSelected(issue.issueId)">
                  <button class="delete-btn" (click)="removeIssue(issue.issueId)" title="Remove this issue">üóëÔ∏è</button>
                  <div class="issue-header">
                    <div>
                      <div class="issue-key">{{ issue.issueKey }}</div>
                      <div class="issue-title">{{ issue.title }}</div>
                    </div>
                    <div class="story-points">{{ issue.storyPoints }} pts</div>
                  </div>
                  <p class="issue-desc">{{ issue.rationale }}</p>
                  @if (issue.suggestedAssigneeId) {
                    <p class="issue-assignee">
                      <span class="assignee-label">Suggested Assignee:</span> 
                      <span class="assignee-name">{{ getAssigneeName(issue.suggestedAssigneeId) }}</span>
                    </p>
                  }
                </div>
              }
            </div>
          </div>

          <!-- AI Recommendations Section -->
          @if (suggestions.recommendations && suggestions.recommendations.length > 0) {
            <div class="ai-section">
              <div class="section-header">
                <span class="icon">üí°</span>
                <h3>AI Recommendations</h3>
              </div>

              @for (rec of suggestions.recommendations; track $index) {
                <div class="recommend-card" [ngClass]="rec.severity?.toLowerCase()">
                  <div class="recommend-header">
                    <h4>{{ rec.type | uppercase }}</h4>
                    <span class="badge">{{ rec.severity | uppercase }}</span>
                  </div>
                  <p>{{ rec.message }}</p>
                </div>
              }
            </div>
          }

          <!-- Capacity Analysis Section -->
          @if (suggestions.capacityAnalysis) {
            <div class="ai-section capacity-section">
              <div class="section-header">
                <span class="icon">üìä</span>
                <h3>Capacity Analysis</h3>
              </div>

              <div class="capacity-grid">
                <div>
                  <p class="label">Team Capacity Utilization</p>
                  <p class="value">{{ suggestions.capacityAnalysis.teamCapacityUtilization }}%</p>
                  <div class="progress-bar">
                    <div class="progress-fill" 
                         [style.width.%]="suggestions.capacityAnalysis.teamCapacityUtilization"
                         [class.high]="suggestions.capacityAnalysis.teamCapacityUtilization > 80"
                         [class.medium]="suggestions.capacityAnalysis.teamCapacityUtilization >= 50 && suggestions.capacityAnalysis.teamCapacityUtilization <= 80"
                         [class.low]="suggestions.capacityAnalysis.teamCapacityUtilization < 50"></div>
                  </div>
                </div>

                <div>
                  <p class="label">Estimated Completion Probability</p>
                  <p class="value">{{ suggestions.capacityAnalysis.estimatedCompletionProbability }}%</p>
                  <div class="progress-bar">
                    <div class="progress-fill" 
                         [style.width.%]="suggestions.capacityAnalysis.estimatedCompletionProbability"
                         [class.high]="suggestions.capacityAnalysis.estimatedCompletionProbability > 70"
                         [class.medium]="suggestions.capacityAnalysis.estimatedCompletionProbability >= 40 && suggestions.capacityAnalysis.estimatedCompletionProbability <= 70"
                         [class.low]="suggestions.capacityAnalysis.estimatedCompletionProbability < 40"></div>
                  </div>
                </div>
              </div>

              @if (suggestions.capacityAnalysis.riskFactors && suggestions.capacityAnalysis.riskFactors.length > 0) {
                <div class="risk-box">
                  <h4>‚ö†Ô∏è Risk Factors</h4>
                  <ul>
                    @for (risk of suggestions.capacityAnalysis.riskFactors; track $index) {
                      <li>{{ risk }}</li>
                    }
                  </ul>
                </div>
              }
            </div>
          }
        </div>
      }

      <!-- Error State -->
      @if (!isStillLoading && !suggestions) {
        <div class="error-container">
          <svg class="error-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <p class="error-text">Unable to generate suggestions</p>
        </div>
      }
    </div>

    <!-- Modal Footer -->
    @if (!isStillLoading) {
      <div class="modal-footer">
        <button class="btn-secondary btn-outline" (click)="onClose()">
          Discard Suggestions
        </button>
        <button class="btn-primary" 
                (click)="onCommit()" 
                [disabled]="!suggestions || getDisplayedIssuesCount() === 0"
                [title]="getDisplayedIssuesCount() === 0 ? 'No issues available' : 'Add issues to sprint'">
          + Add {{ getDisplayedIssuesCount() }} Issues to Sprint
        </button>
      </div>
    }
  </div>
</div>
}