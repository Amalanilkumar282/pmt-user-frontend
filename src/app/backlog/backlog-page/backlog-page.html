<div class="layout-wrapper">
  <!-- Sidebar -->
  <app-sidebar></app-sidebar>

  <!-- Navbar -->
  <app-navbar 
    [class.sidebar-collapsed]="isSidebarCollapsed()"
    (toggleSidebar)="onToggleSidebar()">
  </app-navbar>

  <!-- Epic Panel -->
  @if (isEpicPanelOpen) {
    <app-epic-container 
      [projectId]="currentProjectId"
      [class.sidebar-collapsed]="isSidebarCollapsed()"
      (closeEpicPanel)="closeEpicPanel()"
      (viewDetails)="openEpicDetailView($event)"
      (epicCreated)="onEpicCreated($event)">
    </app-epic-container>
  }

  <!-- Epic Detail View Panel -->
  @if (selectedEpic) {
    <div class="epic-detail-panel-wrapper" 
         [class.sidebar-collapsed]="isSidebarCollapsed()"
         [class.epic-panel-open]="isEpicPanelOpen">
      <app-epic-detailed-view 
        [epic]="selectedEpic"
        (close)="closeEpicDetailView()"
        (epicUpdated)="onEpicUpdated($event)"
        (epicDeleted)="onEpicDeleted($event)">
      </app-epic-detailed-view>
    </div>
  }

  <!-- Main Content -->
  <div class="page-container" 
       [class.sidebar-collapsed]="isSidebarCollapsed()"
       [class.epic-panel-open]="isEpicPanelOpen"
       [class.epic-detail-open]="selectedEpic"
       [style.margin-right.px]="selectedEpic ? epicDetailPanelWidth : 0">
    <!-- Filters Section - Now includes view toggle, epic controls, and sprint visibility -->
    <app-filters 
      [epicOptions]="epicFilterOptions"
      (filtersChanged)="onFiltersChanged($event)">
    </app-filters>

    <!-- Page Header - Simplified -->
    <div class="page-header">
      <button 
        class="create-sprint-btn"
        (click)="handleCreateSprint()">
        + Create Sprint
      </button>
    </div>
  
  <!-- Sprints View -->
  @if (currentView === 'sprints') {
    <!-- Active Sprints Section -->
    @if (activeSprints.length > 0) {
      <section class="section">
        <h2 class="section-title">
          Active Sprints ({{ activeSprints.length }})
        </h2>
        <div class="sprint-list">
          @for (sprint of activeSprints; track sprint.id) {
            <app-sprint-container 
              [sprint]="sprint"
              [availableSprints]="availableSprintsForMove"
              [connectedDropLists]="getConnectedDropListsForSprint(sprint.id)"
              (startSprint)="handleStart($event)"
              (completeSprint)="handleComplete($event)"
              (editSprint)="handleEdit($event)"
              (deleteSprint)="handleDelete($event)"
              (moveIssue)="handleMoveIssue($event.issueId, $event.destinationSprintId)">
            </app-sprint-container>
          }
        </div>
      </section>
    }

    <!-- Planned Sprints Section -->
    @if (plannedSprints.length > 0) {
      <section class="section">
        <h2 class="section-title">
          Planned Sprints ({{ plannedSprints.length }})
        </h2>
        <div class="sprint-list">
          @for (sprint of plannedSprints; track sprint.id) {
            <app-sprint-container 
              [sprint]="sprint"
              [availableSprints]="availableSprintsForMove"
              [connectedDropLists]="getConnectedDropListsForSprint(sprint.id)"
              (startSprint)="handleStart($event)"
              (completeSprint)="handleComplete($event)"
              (editSprint)="handleEdit($event)"
              (deleteSprint)="handleDelete($event)"
              (moveIssue)="handleMoveIssue($event.issueId, $event.destinationSprintId)">
            </app-sprint-container>
          }
        </div>
      </section>
    }

    <!-- Completed Sprints Section - conditionally shown -->
    @if (showCompletedSprints && completedSprints.length > 0) {
      <section class="section completed-sprints-section">
        <h2 class="section-title">
          Completed Sprints ({{ completedSprints.length }})
        </h2>
        <div class="sprint-list">
          @for (sprint of completedSprints; track sprint.id) {
            <app-sprint-container 
              [sprint]="sprint"
              [availableSprints]="availableSprintsForMove"
              [connectedDropLists]="getConnectedDropListsForSprint(sprint.id)"
              (startSprint)="handleStart($event)"
              (completeSprint)="handleComplete($event)"
              (editSprint)="handleEdit($event)"
              (deleteSprint)="handleDelete($event)"
              (moveIssue)="handleMoveIssue($event.issueId, $event.destinationSprintId)">
            </app-sprint-container>
          }
        </div>
      </section>
    }

    <!-- Product Backlog Section -->
    <section>
      <h2 class="section-title">
        Product Backlog
      </h2>
      <app-backlog-container 
        [issues]="filteredBacklogIssues"
        [availableSprints]="availableSprintsForMove"
        [connectedDropLists]="connectedDropListsForBacklog"
        (moveIssue)="handleMoveIssue($event.issueId, $event.destinationSprintId)">
      </app-backlog-container>
    </section>
  }

  <!-- All Issues View -->
  @if (currentView === 'all-issues') {
    <section>
      @if (isLoadingIssues) {
        <div class="flex items-center justify-center py-12">
          <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-gray-300 border-t-blue-600 mb-4"></div>
            <p class="text-gray-600">Loading issues...</p>
          </div>
        </div>
      } @else {
        <app-all-issues-list 
          [issues]="allIssues"
          [availableSprints]="availableSprintsForMove"
          (moveIssue)="handleMoveIssue($event.issueId, $event.destinationSprintId)">
        </app-all-issues-list>
      }
    </section>
  }
  </div>
</div>


<!-- Create Sprint Modal - Now using ModalService, no separate component needed -->

<!-- AI Sprint Planning Modal -->
@if (isAIModalOpen) {
  <app-ai-sprint-modal
    [isOpen]="isAIModalOpen"
    [suggestions]="aiSuggestions"
    [isLoading]="isLoadingAISuggestions"
    (close)="closeAIModal()"
    (commit)="handleCommitAISuggestions($event)">
  </app-ai-sprint-modal>
}

